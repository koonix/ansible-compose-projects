- name: '[{{ project.name }}] Create dirs'
  ansible.builtin.file:
    state: directory
    path: '{{ item.path }}'
    mode: '{{ item.mode | default("700") }}'
    owner: root
    group: root
  loop:
    - path: '{{ project_dir }}'

- name: '[{{ project.name }}] Install compose.yml'
  ansible.builtin.template:
    src: '{{ item.src }}'
    dest: '{{ item.dest }}'
    mode: '{{ item.mode | default("644") }}'
    owner: root
    group: root
  loop:
    - src: compose.yml.j2
      dest: '{{ project_dir }}/compose.yml'

- name: '[{{ project.name }}] Remove extraneous objects from the project dir'
  ansible.builtin.shell:
    chdir: '{{ dir }}'
    cmd: |
      for path in * .*; do
        [ ! -e "$path" ] && continue
        case $path in
          {{ ( [ '.', '..' ] + keep ) | map('ansible.builtin.quote') | join('|') }}) ;;
          *) rm -r -- "$path"; echo removed ;;
        esac
      done
  register: rmextra
  changed_when: "'removed' in rmextra.stdout"
  vars:
    # IMPORTANT: update the 'keep' list to reflect the files that we want to keep
    dir: '{{ project_dir }}'
    keep: '{{ [ "compose.yml" ] + ( ( project.assets | default([]) ) | map(attribute="name") ) }}'

- name: '[{{ project.name }}] Find assets that are about to be updated'
  ansible.builtin.copy:
    content: '{{ item.content }}'
    dest: '{{ project_dir }}/{{ item.name }}'
    mode: '{{ item.mode | default("644") }}'
    owner: root
    group: root
  check_mode: true
  loop: '{{ project.assets | default([]) }}'
  register: assets

- name: '[{{ project.name }}] Run pre-install hooks of assets'
  ansible.builtin.command:
    argv: '{{ item }}'
    chdir: '{{ project_dir }}'
  changed_when: true
  loop: '{{ hooks | ansible.builtin.unique }}'
  vars:
    hooks: '{{ assets.results | selectattr("changed", "equalto", True) | map(attribute="item") | selectattr("hooks_pre", "defined") | map(attribute="hooks_pre") | ansible.builtin.flatten(levels=1) }}'

- name: '[{{ project.name }}] Install assets'
  ansible.builtin.copy:
    content: '{{ item.content }}'
    dest: '{{ project_dir }}/{{ item.name }}'
    mode: '{{ item.mode | default("644") }}'
    owner: root
    group: root
  loop: '{{ project.assets | default([]) }}'
  register: assets

- name: '[{{ project.name }}] Run post-install hooks of assets'
  ansible.builtin.command:
    argv: '{{ item }}'
    chdir: '{{ project_dir }}'
  changed_when: true
  loop: '{{ hooks | ansible.builtin.unique }}'
  vars:
    hooks: '{{ assets.results | selectattr("changed", "equalto", True) | map(attribute="item") | selectattr("hooks_post", "defined") | map(attribute="hooks_post") | ansible.builtin.flatten(levels=1) }}'

- name: '[{{ project.name }}] Start the stack'
  ansible.builtin.command:
    argv: [ docker, compose, up, --detach, --remove-orphans ]
    chdir: '{{ project_dir }}'
  register: compose
  changed_when: '"Started" in compose.stderr'
